
<!--
{{ $caption := replaceRE "^Figure [0-9]+: " "" (.Get "caption") }}
<figure{{ with .Get "class" }} class="{{ . }}"{{ end }}>
  {{- if .Scratch.Get "link" -}}
    link v
    <a href="{{ .Scratch.Get "link" }}" {{ with .Get "target" }} target="{{ . }}"{{ end }}>
    link ^
  {{- end -}}
  preview v
  <img src="{{ .Scratch.Get "preview-src" }}"
    {{- if or (.Get "alt") $caption }}
      alt="{{ with .Get "alt" }}{{ . }}{{ else }}{{ $caption | markdownify | plainify }}{{ end }}"
    {{- end -}}
    {{- with .Get "width" }} width="{{ . }}"{{ end -}}
    {{- with .Get "height" }} height="{{ . }}"{{ end -}}
  />
  preview ^
  {{- if .Scratch.Get "link" }}
    </a>
  {{ end -}}
  {{- if or $caption (.Get "attr") -}}
    <figcaption>
      {{- if or $caption (.Get "attr") -}}<p>
        {{- $caption | markdownify -}}
        {{- with .Get "attrlink" }}<a href="{{ . }}">{{- end -}}
        {{- .Get "attr" | markdownify -}}
        {{- if .Get "attrlink" }}
          </a>
        {{ end }}
        </p>
      {{- end }}
    </figcaption>
  {{- end }}
</figure>

Put this file in /layouts/shortcodes/figure.html
NB this overrides Hugo's built-in "figure" shortcode but is backwards compatible
Documentation and licence at https://github.com/liwenyip/hugo-easy-gallery/
-->

{{- if not ($.Page.Scratch.Get "figurecount") }}
  {{- partial "load_photoswipe.html" -}}
  <link rel="stylesheet" href={{ "css/hugo-easy-gallery.css" | relURL }} />
{{ end }}
{{- $.Page.Scratch.Add "figurecount" 1 -}}

<!-- use either src or link-thumb for thumbnail image -->
{{ .Scratch.Set "thumb" (.Get "src" | default (printf "%s." (.Get "thumb") | replace (.Get "link") ".")) }}
{{- if (or ($.Page.Scratch.Get "isgallery") (in (split (.Get "class") " ") "cashpw-gallery")) -}}
  {{ $original := resources.Get (.Get "src") }}
  {{ if and ($original) (not (eq $original.MediaType.SubType "svg")) }}
    {{ .Scratch.Set "thumb" (($original.Resize "300x").Crop "300x300").RelPermalink }}
  {{ end }}
{{- end -}}
{{- $thumb := .Scratch.Get "thumb" -}}

<div class="box{{ with .Get "caption-position" }} fancy-figure caption-position-{{.}}{{end}}{{ with .Get "caption-effect" }} caption-effect-{{.}}{{end}}" {{ with .Get "width" }}style="max-width:{{.}}"{{end}}>
  <figure {{ with .Get "class" }}class="{{.}}"{{ end }} itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img"{{ if .Parent }} style="background-image: url('{{ $thumb | relURL }}');"{{ end }}{{ with .Get "size" }} data-size="{{.}}"{{ end }}>
      <img itemprop="thumbnail" src="{{ $thumb | relURL }}" {{ with .Get "alt" | default (.Get "caption") }}alt="{{.}}"{{ end }}/><!-- <img> hidden if in .gallery -->
    </div>
    {{ with .Get "link" | default (.Get "src") }}<a href="{{ . | relURL }}" itemprop="contentUrl"></a>{{ end }}
    {{- if or (or (.Get "title") (.Get "caption")) (.Get "attr")}}
      <figcaption>
        {{- with .Get "title" }}<h4>{{.}}</h4>{{ end }}
        {{- if or (.Get "caption") (.Get "attr")}}
          <p>
            {{- .Get "caption" -}}
            {{- if .Get "attrlink" }}
              <a href="{{ .Get `attrlink` }}">{{ .Get "attr" }}</a>
            {{- else -}}
              {{ .Get "attr"}}
            {{- end -}}
          </p>
        {{- end }}
      </figcaption>
    {{- end }}
  </figure>
</div>
